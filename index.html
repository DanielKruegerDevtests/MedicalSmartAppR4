<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>MedicalSmartAppR4 by ESS</title>

    <!--<script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>-->
    <script src='./FHIRLib/fhir-client.js'></script>

    <style>
        #patient, #meds, #medResource {
            font-family: Monaco, monospace;
            white-space: pre;
            font-size: 13px;
            height: 30vh;
            overflow: scroll;
            border: 1px solid #CCC;
        }

        .patientDiv {
            float: left;
            width: 33%;
        }

        .medsDiv {
            float: left;
            width: 66%;
        }

        body {
            background-image: url('WavesBackground.jpg');
            background-repeat: no-repeat;
        }
    </style>
   
</head>

<body>
    <h1>Smart App Test by ESS</h1>
    <div id="PatientDiv" class="patientDiv">
        <h4>Patient information</h4>
        <table>
            <tr>
                <td>PatientID:</td>
                <td id="patient_id">Loading...</td>
            </tr>
            <tr>
                <td>Birthdate:</td>
                <td id="patient_birthday">Loading...</td>
            </tr>
            <tr>
                <td>Address:</td>
                <td id="patient_line">Loading...</td>
            </tr>
            <tr>
                <td></td>
                <td id="patient_city">Loading...</td>
            </tr>
            <tr>
                <td></td>
                <td id="patient_state">Loading...</td>
            </tr>
            <tr>
                <td></td>
                <td id="patient_postalcode">Loading...</td>
            </tr>
            <tr>
                <td></td>
                <td id="patient_country">Loading...</td>
            </tr>
            <tr>
                <td>Phone:</td>
                <td id="patient_phone">Loading...</td>
            </tr>
            <tr>
                <td>General information:</td>
                <td id="patient_general">Loading...</td>
            </tr>
        </table>
    </div>
    <div id="MedicationDiv" class="medsDiv">
        <h4>Medication</h4>
        <table id="medsTable">
            <tr>
                <th>Id</th>
                <th>Drug name</th>
                <th>Drug code</th>
                <th>Status</th>
                <th>Intend</th>

            </tr>
        </table>
        <!--
        <select name="Intends" size="3">
            <option>proposal</option>
            <option>plan</option>
            <option selected>order</option>
        </select>
        
        <button type="button" id="btnChangeMediIntend">Change drug intent</button>
        -->
        <select id="DrugSelect" name="Drugs" size="3">
            <option>Abuse-Deterrent 12 HR Oxycodone Hydrochloride 15 M</option>
            <option>Camila 28 Day Pack</option>
            <option>Penicillin V Potassium 250 MG Oral Tablet</option>
        </select>
        <button type="button" id="btnAddDrug">Add drug</button>
    </div>


    <!--SCRIPTS-->
        <script type="text/javascript">

            var globalClient; // global variable to hold the client object got by ready-function
            var globalMeds;

            //document.querySelector('#btnChangeMediIntend').addEventListener('click', changeMedicationIntend);
            document.querySelector('#btnAddDrug').addEventListener('click', addDrug);

            FHIR.oauth2.ready().then(function (client) {

                // Render the current patient (or any error)
                globalClient = client;
                client.patient.read().then(
                    function (pt) {
                        document.getElementById("patient_id").innerHTML = pt.id;
                        document.getElementById("patient_birthday").innerHTML = pt.birthDate;
                        document.getElementById("patient_line").innerHTML = pt.address[0].line;
                        document.getElementById("patient_city").innerHTML = pt.address[0].city;
                        document.getElementById("patient_state").innerHTML = pt.address[0].state;
                        document.getElementById("patient_postalcode").innerHTML = pt.address[0].postalCode;
                        document.getElementById("patient_country").innerHTML = pt.address[0].country;
                        document.getElementById("patient_phone").innerHTML = pt.telecom[0].value + " (" + pt.telecom[0].use + ")";
                        document.getElementById("patient_general").innerHTML = pt.maritalStatus.text + ", " + pt.communication[0].language.text;
                        //document.getElementById("patient").innerText = JSON.stringify(patient, null, 4);
                    },
                    function (error) {
                        document.getElementById("patient_id").innerText = error.stack;
                    }
                );

                // Get MedicationRequests for the selected patient
                client.request("/MedicationRequest?patient=" + client.patient.id, {
                    resolveReferences: ["medicationReference"],
                    graph: true
                })

                    // Reject if no MedicationRequests are found
                    .then(function (data) {
                        if (!data.entry || !data.entry.length) {
                            throw new Error("No medications found for the selected patient");
                        }
                        return data.entry;
                    })


                    // Render the current patient's medications (or any error)
                    .then(
                        function (meds) {
                            globalMeds = meds;
                            var myMedsTable = document.getElementById("medsTable");

                            meds.forEach(function (medItem, index) {
                                var myMedsTableRow = myMedsTable.insertRow(index + 1);
                                myMedsTableRow.insertCell(0).innerHTML = medItem.resource.id;
                                myMedsTableRow.insertCell(1).innerHTML = medItem.resource.medicationCodeableConcept.coding[0].display;
                                myMedsTableRow.insertCell(2).innerHTML = medItem.resource.medicationCodeableConcept.coding[0].code;
                                myMedsTableRow.insertCell(3).innerHTML = medItem.resource.status;
                                myMedsTableRow.insertCell(4).innerHTML = medItem.resource.intent;
                            });
                        },
                        function (error) {
                            document.getElementById("drugId").innerText = error.stack;
                        }
                    );

            }).catch(console.error);

            function changeMedicationIntend() {

                var mediResource = globalMeds[0].resource;

                mediResource.intent = "plan";
                document.getElementById("medResource").innerText = JSON.stringify(mediResource, null, 4);
                console.log("Change medication intend");
                console.log(globalClient.update(mediResource));


            }

            function addDrug() {

                console.log("Add drug");

                var mediResource = globalMeds[0].resource;
                var x = document.getElementById("DrugSelect").selectedIndex;

                console.log("Value: " + x);
               // mediResource.intent = "plan";
                //console.log(globalClient.create(mediResource));

            }
        </script>

</body>
</html>
